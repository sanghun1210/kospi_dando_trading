name: ğŸŒ™ Evening Full Analysis

on:
  schedule:
    # í‰ì¼ ì˜¤í›„ 6ì‹œ KST (UTC 9ì‹œ)
    - cron: '0 9 * * 1-5'

  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰
    inputs:
      force_run:
        description: 'ì‹œì¥ ì•½ì„¸ì—¬ë„ ê°•ì œ ì‹¤í–‰'
        type: boolean
        default: false

jobs:
  full-analysis:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: ğŸ“¦ Install dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt

    - name: ğŸŒ Market Filter Check
      id: market
      run: |
        echo "ğŸ“Š ì‹œì¥ ìƒí™© ë¶„ì„ ì¤‘..."
        python market_filter.py > market_report.txt 2>&1 || true

        MARKET_SCORE=$(grep "ì‹œì¥ ì ìˆ˜:" market_report.txt | grep -oP '\-?\d+' | head -1 || echo "0")
        echo "market_score=$MARKET_SCORE" >> $GITHUB_OUTPUT

        # ì‹œì¥ ìƒíƒœ
        MARKET_REGIME=$(grep "ìµœì¢… íŒì •" market_report.txt -A 2 | tail -1 | xargs || echo "unknown")
        echo "market_regime=$MARKET_REGIME" >> $GITHUB_OUTPUT

        cat market_report.txt
      env:
        OPENDART_API_KEY: ${{ secrets.OPENDART_API_KEY }}

    - name: ğŸš¦ Should Run Analysis?
      id: should_run
      run: |
        MARKET_SCORE="${{ steps.market.outputs.market_score }}"
        FORCE_RUN="${{ github.event.inputs.force_run }}"

        if [ "$FORCE_RUN" = "true" ]; then
          echo "ğŸ”´ ê°•ì œ ì‹¤í–‰ ëª¨ë“œ"
          echo "should_run=true" >> $GITHUB_OUTPUT
          echo "reason=ê°•ì œ ì‹¤í–‰" >> $GITHUB_OUTPUT
        elif [ "$MARKET_SCORE" -ge 0 ]; then
          echo "âœ… ì‹œì¥ ì¡°ê±´ ì–‘í˜¸ (ì ìˆ˜: $MARKET_SCORE)"
          echo "should_run=true" >> $GITHUB_OUTPUT
          echo "reason=ì‹œì¥ ì ìˆ˜ $MARKET_SCORE/3" >> $GITHUB_OUTPUT
        else
          echo "ğŸ›‘ ì‹œì¥ ì•½ì„¸ (ì ìˆ˜: $MARKET_SCORE)"
          echo "should_run=false" >> $GITHUB_OUTPUT
          echo "reason=ì‹œì¥ ì•½ì„¸ ($MARKET_SCORE/3)" >> $GITHUB_OUTPUT
        fi

    - name: ğŸ“Š Run Full Analysis
      if: steps.should_run.outputs.should_run == 'true'
      run: |
        echo "ğŸš€ ì „ì²´ ë¶„ì„ ì‹œì‘..."

        FORCE_FLAG=""
        if [ "${{ github.event.inputs.force_run }}" = "true" ]; then
          FORCE_FLAG="--force-run"
        fi

        python run_full_analysis.py \
          --api-key ${{ secrets.OPENDART_API_KEY }} \
          --min-market-score 0 \
          $FORCE_FLAG \
          2>&1 | tee analysis_log.txt

        echo "âœ… ë¶„ì„ ì™„ë£Œ"
      env:
        OPENDART_API_KEY: ${{ secrets.OPENDART_API_KEY }}
      continue-on-error: true

    - name: ğŸ“‹ Extract Results
      if: steps.should_run.outputs.should_run == 'true'
      id: results
      run: |
        # ìµœì‹  ê²°ê³¼ íŒŒì¼ ì°¾ê¸°
        TIMING_FILE=$(ls -t hybrid_timing_results_*.csv 2>/dev/null | head -1)
        LITE_FILE=$(ls -t hybrid_lite_results_*.csv 2>/dev/null | head -1)
        FULL_FILE=$(ls -t hybrid_full_results_*.csv 2>/dev/null | head -1)

        if [ -n "$TIMING_FILE" ]; then
          echo "âœ… íƒ€ì´ë° ê²°ê³¼: $TIMING_FILE"
          echo "timing_file=$TIMING_FILE" >> $GITHUB_OUTPUT

          # ìƒìœ„ 10ê°œ ì¶”ì¶œ
          head -11 "$TIMING_FILE" > top10_stocks.csv

          # í†µê³„
          TOTAL=$(tail -n +2 "$TIMING_FILE" | wc -l)
          echo "total_stocks=$TOTAL" >> $GITHUB_OUTPUT
          echo "results_found=true" >> $GITHUB_OUTPUT
        else
          echo "âš ï¸ ê²°ê³¼ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          echo "results_found=false" >> $GITHUB_OUTPUT
        fi

    - name: ğŸ’¾ Upload Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: analysis-results-${{ github.run_number }}
        path: |
          hybrid_timing_results_*.csv
          hybrid_lite_results_*.csv
          hybrid_full_results_*.csv
          top10_stocks.csv
          market_report.txt
          analysis_log.txt
        retention-days: 90
        if-no-files-found: ignore

    - name: ğŸ“ Create GitHub Issue
      if: steps.should_run.outputs.should_run == 'true' && steps.results.outputs.results_found == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const date = new Date().toISOString().split('T')[0];

          // ìƒìœ„ 10ê°œ ì½ê¸°
          let top10Content = '';
          if (fs.existsSync('top10_stocks.csv')) {
            top10Content = fs.readFileSync('top10_stocks.csv', 'utf8');
          }

          // ì‹œì¥ ì ìˆ˜ë¡œ ë¼ë²¨ ê²°ì •
          const marketScore = ${{ steps.market.outputs.market_score }};
          let scoreLabel = 'neutral';
          if (marketScore >= 2) scoreLabel = 'bullish';
          else if (marketScore >= 1) scoreLabel = 'slightly-bullish';
          else if (marketScore <= -2) scoreLabel = 'bearish';
          else if (marketScore <= -1) scoreLabel = 'slightly-bearish';

          const issueBody = `
          ## ğŸ“Š ì£¼ì‹ ë¶„ì„ ê²°ê³¼ - ${date}

          ### ğŸŒ ì‹œì¥ ìƒí™©
          - **ì‹œì¥ ì ìˆ˜**: ${{ steps.market.outputs.market_score }}/3
          - **ì‹œì¥ ìƒíƒœ**: ${{ steps.market.outputs.market_regime }}
          - **ë¶„ì„ ì¢…ëª© ìˆ˜**: ${{ steps.results.outputs.total_stocks }}ê°œ

          ### ğŸ† ìƒìœ„ 10ê°œ ì¶”ì²œ ì¢…ëª©

          \`\`\`csv
          ${top10Content}
          \`\`\`

          ### ğŸ“¥ ì „ì²´ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ

          [Artifactsì—ì„œ ë‹¤ìš´ë¡œë“œ](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ### ğŸ’¡ íˆ¬ì ì „ëµ

          ${marketScore >= 2 ? 'âœ… **ì ê·¹ ë§¤ìˆ˜ ê°€ëŠ¥**\n- ìƒìœ„ ì¢…ëª© ì¤‘ì‹¬ìœ¼ë¡œ í¬íŠ¸í´ë¦¬ì˜¤ êµ¬ì„±\n- ë¶„ì‚° íˆ¬ì ê¶Œì¥ (10~20ê°œ)' :
            marketScore >= 1 ? 'ğŸŸ¡ **ì„ ë³„ ë§¤ìˆ˜**\n- ê³ ë“ì  ì¢…ëª©ë§Œ ì„ ë³„\n- ë³´ìˆ˜ì  í¬íŠ¸í´ë¦¬ì˜¤ (5~10ê°œ)' :
            marketScore >= 0 ? 'ğŸŸ  **ì‹ ì¤‘í•œ ë§¤ìˆ˜**\n- ìµœê³  ë“ì  ì¢…ëª©ë§Œ ì†ŒëŸ‰\n- ë°©ì–´ì£¼ ì¤‘ì‹¬' :
            'ğŸ”´ **ê´€ë§ ê¶Œì¥**\n- ë§¤ìˆ˜ ë³´ë¥˜\n- ì‹œì¥ íšŒë³µ ëŒ€ê¸°'}

          ---

          <details>
          <summary>ğŸ“Š ì‹œì¥ ìƒì„¸ ë¶„ì„</summary>

          \`\`\`
          ${fs.existsSync('market_report.txt') ?
            fs.readFileSync('market_report.txt', 'utf8').split('\n').slice(0, 50).join('\n') :
            'ë°ì´í„° ì—†ìŒ'}
          \`\`\`

          </details>

          ---

          **ë‹¤ìŒ ë¶„ì„**: ë‚´ì¼ ì˜¤í›„ 6ì‹œ
          **ì•„ì¹¨ ì²´í¬**: ë‚´ì¼ ì˜¤ì „ 7:50
          `;

          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ğŸ“ˆ ì£¼ì‹ ë¶„ì„ - ${date}`,
            body: issueBody,
            labels: ['stock-analysis', 'automated', scoreLabel]
          });

          console.log('âœ… GitHub Issue ìƒì„± ì™„ë£Œ');

    - name: ğŸ“ Create Issue for Market Skip
      if: steps.should_run.outputs.should_run == 'false'
      uses: actions/github-script@v7
      with:
        script: |
          const date = new Date().toISOString().split('T')[0];

          const issueBody = `
          ## ğŸ›‘ ì‹œì¥ ì•½ì„¸ë¡œ ë¶„ì„ ìƒëµ - ${date}

          ### ğŸŒ ì‹œì¥ ìƒí™©
          - **ì‹œì¥ ì ìˆ˜**: ${{ steps.market.outputs.market_score }}/3
          - **íŒì •**: ${{ steps.market.outputs.market_regime }}

          ### ğŸ’¡ ê¶Œì¥ ì¡°ì¹˜
          - ë§¤ìˆ˜ ë³´ë¥˜
          - ì‹œì¥ íšŒë³µ ëŒ€ê¸°
          - ê³¨ë“ í¬ë¡œìŠ¤ ë°œìƒ ì‹œ ìë™ìœ¼ë¡œ ë¶„ì„ ì¬ê°œ

          ### ğŸ“Š ë‹¤ìŒ ì²´í¬
          - ë‚´ì¼ ì˜¤ì „ 7:50 ì‹œì¥ í•„í„°
          - ë‚´ì¼ ì˜¤í›„ 6:00 ì „ì²´ ë¶„ì„ (ì¡°ê±´ ì¶©ì¡± ì‹œ)

          ---

          <details>
          <summary>ì‹œì¥ ìƒì„¸ ë¶„ì„</summary>

          \`\`\`
          ${require('fs').existsSync('market_report.txt') ?
            require('fs').readFileSync('market_report.txt', 'utf8') :
            'ë°ì´í„° ì—†ìŒ'}
          \`\`\`

          </details>
          `;

          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `â¸ï¸ ë¶„ì„ ìƒëµ - ${date}`,
            body: issueBody,
            labels: ['market-skip', 'automated']
          });

    - name: ğŸ“± Send Telegram Notification
      if: always()
      run: |
        if [ -f ".github/scripts/send_telegram.py" ]; then
          python .github/scripts/send_telegram.py \
            --token "${{ secrets.TELEGRAM_BOT_TOKEN }}" \
            --chat-id "${{ secrets.TELEGRAM_CHAT_ID }}" \
            --type "evening" \
            --market-score "${{ steps.market.outputs.market_score }}" \
            --should-run "${{ steps.should_run.outputs.should_run }}" \
            --total-stocks "${{ steps.results.outputs.total_stocks }}" \
            --run-url "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        else
          echo "âš ï¸ í…”ë ˆê·¸ë¨ ìŠ¤í¬ë¦½íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤"
        fi
      continue-on-error: true

    - name: âœ… Summary
      if: always()
      run: |
        echo "## ğŸŒ™ ì €ë… ì „ì²´ ë¶„ì„ ($(date +%Y-%m-%d))" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ì‹œì¥ ì ìˆ˜: **${{ steps.market.outputs.market_score }}/3**" >> $GITHUB_STEP_SUMMARY
        echo "### ë¶„ì„ ì‹¤í–‰: ${{ steps.should_run.outputs.should_run }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ steps.should_run.outputs.should_run }}" = "true" ]; then
          echo "### âœ… ë¶„ì„ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ë¶„ì„ ì¢…ëª©: ${{ steps.results.outputs.total_stocks }}ê°œ" >> $GITHUB_STEP_SUMMARY
          echo "- [ê²°ê³¼ ë‹¤ìš´ë¡œë“œ](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "- [Issuesì—ì„œ ë³´ê¸°](https://github.com/${{ github.repository }}/issues?q=is%3Aissue+label%3Astock-analysis)" >> $GITHUB_STEP_SUMMARY
        else
          echo "### ğŸ›‘ ì‹œì¥ ì•½ì„¸ë¡œ ë¶„ì„ ìƒëµ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ì´ìœ **: ${{ steps.should_run.outputs.reason }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ì‹œì¥ì´ íšŒë³µë˜ë©´ ìë™ìœ¼ë¡œ ë¶„ì„ì´ ì¬ê°œë©ë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ“Œ **ë‹¤ìŒ ìŠ¤ì¼€ì¤„**" >> $GITHUB_STEP_SUMMARY
        echo "- ë‚´ì¼ ì˜¤ì „ 7:50 - ì‹œì¥ ì²´í¬" >> $GITHUB_STEP_SUMMARY
        echo "- ë‚´ì¼ ì˜¤í›„ 6:00 - ì „ì²´ ë¶„ì„" >> $GITHUB_STEP_SUMMARY
