name: ğŸŒ… Morning Market Check

on:
  schedule:
    # í‰ì¼ ì˜¤ì „ 7:50 KST (UTC 22:50 ì „ë‚ )
    - cron: '50 22 * * 0-4'

  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰

jobs:
  market-check:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: ğŸ“¦ Install dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt

    - name: ğŸŒ Check Market
      id: market
      run: |
        echo "ğŸ“Š ì‹œì¥ ìƒí™© ë¶„ì„ ì¤‘..."
        python market_filter.py > market_report.txt 2>&1 || true

        # ì‹œì¥ ì ìˆ˜ ì¶”ì¶œ
        MARKET_SCORE=$(grep "ì‹œì¥ ì ìˆ˜:" market_report.txt | grep -oP '\-?\d+' | head -1 || echo "0")
        echo "market_score=$MARKET_SCORE" >> $GITHUB_OUTPUT

        # ì‹œì¥ ìƒíƒœ
        if grep -q "ê°•í•œ ìƒìŠ¹\|ì ê·¹ ë§¤ìˆ˜" market_report.txt; then
          VERDICT="ğŸŸ¢ ë§¤ìˆ˜ ì ê·¹ ì¶”ì²œ"
        elif grep -q "ì„ ë³„ ë§¤ìˆ˜\|ì•½í•œ ìƒìŠ¹" market_report.txt; then
          VERDICT="ğŸŸ¡ ì„ ë³„ ë§¤ìˆ˜"
        elif grep -q "ê´€ë§\|í•˜ë½" market_report.txt; then
          VERDICT="ğŸ”´ ë§¤ìˆ˜ ëŒ€ê¸° ê¶Œì¥"
        else
          VERDICT="âšª ì¤‘ë¦½"
        fi
        echo "verdict=$VERDICT" >> $GITHUB_OUTPUT

        # ê³¨ë“ í¬ë¡œìŠ¤ ì²´í¬
        if grep -q "ê³¨ë“ í¬ë¡œìŠ¤" market_report.txt; then
          echo "golden_cross=âœ¨ ê³¨ë“ í¬ë¡œìŠ¤ ë°œìƒ!" >> $GITHUB_OUTPUT
        else
          echo "golden_cross=" >> $GITHUB_OUTPUT
        fi

        cat market_report.txt
      env:
        OPENDART_API_KEY: ${{ secrets.OPENDART_API_KEY }}

    - name: ğŸ“Š Summary
      run: |
        echo "## ğŸŒ… ì•„ì¹¨ ì‹œì¥ ì²´í¬ ($(date +%Y-%m-%d))" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ì‹œì¥ ì ìˆ˜: **${{ steps.market.outputs.market_score }}/3**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### íŒì •: ${{ steps.market.outputs.verdict }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ -n "${{ steps.market.outputs.golden_cross }}" ]; then
          echo "### ${{ steps.market.outputs.golden_cross }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi

        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ’¡ **ì˜¤ëŠ˜ ë§¤ìˆ˜ ì „ëµ:**" >> $GITHUB_STEP_SUMMARY

        SCORE=${{ steps.market.outputs.market_score }}
        if [ "$SCORE" -ge 2 ]; then
          echo "- âœ… ì ê·¹ ë§¤ìˆ˜ ê°€ëŠ¥" >> $GITHUB_STEP_SUMMARY
          echo "- ì–´ì œ ì €ë… ë¶„ì„ ê²°ê³¼ ìƒìœ„ ì¢…ëª© ë§¤ìˆ˜" >> $GITHUB_STEP_SUMMARY
        elif [ "$SCORE" -ge 0 ]; then
          echo "- âš ï¸ ì‹ ì¤‘í•˜ê²Œ ì„ ë³„ ë§¤ìˆ˜" >> $GITHUB_STEP_SUMMARY
          echo "- ê³ ë“ì  ì¢…ëª© ì¤‘ì‹¬ìœ¼ë¡œ ì†ŒëŸ‰ ë§¤ìˆ˜" >> $GITHUB_STEP_SUMMARY
        else
          echo "- ğŸ›‘ ë§¤ìˆ˜ ëŒ€ê¸° ê¶Œì¥" >> $GITHUB_STEP_SUMMARY
          echo "- í˜„ê¸ˆ ë³´ìœ  ë˜ëŠ” ë°©ì–´ì£¼ë§Œ ê³ ë ¤" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ“Œ ìƒì„¸ ë¶„ì„ì€ [ì €ë… 6ì‹œ ê²°ê³¼](https://github.com/${{ github.repository }}/issues?q=is%3Aissue+label%3Astock-analysis)ë¥¼ ì°¸ê³ í•˜ì„¸ìš”" >> $GITHUB_STEP_SUMMARY

    - name: ğŸ’¾ Upload Report
      uses: actions/upload-artifact@v4
      with:
        name: morning-check-${{ github.run_number }}
        path: market_report.txt
        retention-days: 7

    - name: ğŸ“± Send Telegram Alert
      if: always()
      run: |
        if [ -f ".github/scripts/send_telegram.py" ]; then
          python .github/scripts/send_telegram.py \
            --token "${{ secrets.TELEGRAM_BOT_TOKEN }}" \
            --chat-id "${{ secrets.TELEGRAM_CHAT_ID }}" \
            --type "morning" \
            --market-score "${{ steps.market.outputs.market_score }}" \
            --verdict "${{ steps.market.outputs.verdict }}" \
            --golden-cross "${{ steps.market.outputs.golden_cross }}"
        else
          echo "âš ï¸ í…”ë ˆê·¸ë¨ ìŠ¤í¬ë¦½íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤"
        fi
      continue-on-error: true
